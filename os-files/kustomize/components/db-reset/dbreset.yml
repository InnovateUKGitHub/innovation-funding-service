apiVersion: v1
kind: Pod
metadata:
  name: dbreset
spec:
  imagePullSecrets:
    - name: regcred
  containers:
    - name: dbreset
      image: dbreset
      imagePullPolicy: Always
      command: [ "/bin/bash", "-exec" ]
      args:
        - |
          cat > /flyway/flyway.conf <<EOF
          flyway.url=jdbc:mysql://$DB_HOST:$DB_PORT
          flyway.schemas=$DB_NAME
          flyway.locations=filesystem:/flyway/sql/db/migration,filesystem:/flyway/sql/db/reference,filesystem:/flyway/sql/db/setup,filesystem:/flyway/sql/db/webtest
          flyway.placeholders.ifs.system.user.uuid=$SYSTEM_USER_UUID
          flyway.user=$DB_USER
          flyway.password=$DB_PASS
          flyway.table=$FLYWAY_TABLE
          EOF
          . /clean-migrate-db-sync-ldap.sh
      envFrom:
        - configMapRef:
            name: db-config
        - configMapRef:
            name: performance-config
        - configMapRef:
            name: ldap-config
        - configMapRef:
            name: flyway-config
      env:
        - name: SYSTEM_USER_UUID
          valueFrom:
            configMapKeyRef:
              name: flyway-config
              key: SYSTEM_USER_UUID
        - name: IFS_TEST_USER_PASSWORD
          value: "%%IFS_TEST_USER_PASSWORD%%"
  restartPolicy: Never