apiVersion: apps/v1
kind: Deployment
metadata:
  name: idp
  annotations:
    pullSecrets: pullSecrets
spec:
  replicas: 1
  selector:
    matchLabels:
      app: idp
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 2
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: idp
    spec:
      hostname: idp
      volumes:
        - name: idp-keys-volume
          secret:
            secretName: idp-keys-secrets
        - name: shibboleth-volume
          secret:
            secretName: sp-secrets
      containers:
        - image: docker-ifs.devops.innovateuk.org/snapshots/idp-service:2d21fb5
          name: idp
          workingDir: /usr/local/bin
          volumeMounts:
            - name: idp-keys-volume
              mountPath: /var/certs
            - name: shibboleth-volume
              mountPath: /var/shibboleth
          livenessProbe:
            httpGet:
              path: /idp/status
              port: 9443
              scheme: HTTPS
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /idp/status
              port: 9443
              scheme: HTTPS
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 5
          imagePullPolicy: IfNotPresent
          envFrom:
            - configMapRef:
                name: ldap-config
            - configMapRef:
                name: shibboleth-config
            - configMapRef:
                name: web-config
            - configMapRef:
                name: idp-config
          env:
            - name: JAVA_TOOL_OPTIONS
              value: -Xms384M -Xmx768M -javaagent:/newrelic.jar
            - name: NEW_RELIC_APP_NAME
              value: "ifs-idp-service"
            - name: HTTPS_PORT
              value: "9443"
            - name: HTTP_PORT
              value: "9080"
          ports:
            - containerPort: 9443
            - containerPort: 9080
          resources:
            requests:
              memory: 500M
            limits:
              memory: 2048M
