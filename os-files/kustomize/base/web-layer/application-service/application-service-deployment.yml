apiVersion: apps/v1
kind: Deployment
metadata:
  name: application-svc
spec:
  replicas: 1
  selector:
    matchLabels:
      run: application-svc
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1 #So Flyway runs on one thread at a time
      maxUnavailable: 0
  template:
    metadata:
      labels:
        run: application-svc
  spec:
    initContainers:
      - name: init-wait-for-db
        image: alpine
        command: [ "/bin/sh", "-c", "for i in $(seq 1 300); do nc -zvw1 ifs-database 3306 && exit 0 || sleep 3; done; exit 1" ]
    containers:
    - image: innovateuk/application-service
      name: application-svc
      livenessProbe:
        httpGet:
          path: /monitoring/health
          port: 8080
        initialDelaySeconds: 100
        periodSeconds: 31
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 3
      readinessProbe:
        httpGet:
          path: /monitoring/health
          port: 8080
        initialDelaySeconds: 100
        periodSeconds: 5
        timeoutSeconds: 5
        successThreshold: 1
        failureThreshold: 1
      imagePullPolicy: Always
      env:
        - name: IFS_NEW_ORGANISATION_SEARCH_ENABLED
          valueFrom:
            configMapKeyRef:
              name: feature-toggle-config
              key: IFS_NEW_ORGANISATION_SEARCH_ENABLED
        - name: IFS_KTP_FEC_FINANCE_MODEL_ENABLED
          valueFrom:
            configMapKeyRef:
              name: feature-toggle-config
              key: IFS_KTP_FEC_FINANCE_MODEL_ENABLED
        - name: SPRING_APPLICATION_JSON
          valueFrom:
            configMapKeyRef:
              name: web-config
              key: SPRING_APPLICATION_JSON
        - name: IFS_WEB_GOOGLEANALYTICS_TRACKINGID
          valueFrom:
            configMapKeyRef:
              name: web-config
              key: IFS_WEB_GOOGLEANALYTICS_TRACKINGID
        - name: IFS_WEB_SYSTEM_USER_UID
          valueFrom:
            configMapKeyRef:
              name: web-config
              key: IFS_WEB_SYSTEM_USER_UID
        - name: IFS_WEB_REST_CONNECTIONS_MAX_TOTAL
          valueFrom:
            configMapKeyRef:
              name: web-config
              key: IFS_WEB_REST_CONNECTIONS_MAX_TOTAL
        - name: IFS_WEB_REST_CONNECTIONS_MAX_PER_ROUTE
          valueFrom:
            configMapKeyRef:
              name: web-config
              key: IFS_WEB_REST_CONNECTIONS_MAX_PER_ROUTE
        - name: IFS_WEB_AJP_CONNECTIONS_MAX_TOTAL
          valueFrom:
            configMapKeyRef:
              name: web-config
              key: IFS_WEB_AJP_CONNECTIONS_MAX_TOTAL
        - name: IFS_WEB_AJP_CONNECTIONS_ACCEPT_COUNT
          valueFrom:
            configMapKeyRef:
              name: web-config
              key: IFS_WEB_AJP_CONNECTIONS_ACCEPT_COUNT
        - name: IFS_WEB_AJP_CONNECTIONS_MAX_THREADS
          valueFrom:
            configMapKeyRef:
              name: web-config
              key: IFS_WEB_AJP_CONNECTIONS_MAX_THREADS
        - name: IFS_LIVE_PROJECTS_LANDING_PAGE_URL
          valueFrom:
            configMapKeyRef:
              name: web-config
              key: IFS_LIVE_PROJECTS_LANDING_PAGE_URL
        - name: IFS_EARLY_METRICS_URL
          valueFrom:
            configMapKeyRef:
              name: web-config
              key: IFS_EARLY_METRICS_URL
        - name: IFS_WEB_VIRTUALASSISTANT_BOTSECRET
          valueFrom:
            configMapKeyRef:
              name: web-config
              key: IFS_WEB_VIRTUALASSISTANT_BOTSECRET
        - name: IFS_WEB_VIRTUALASSISTANT_BOTID
          valueFrom:
            configMapKeyRef:
              name: web-config
              key: IFS_WEB_VIRTUALASSISTANT_BOTID
        - name: NEW_RELIC_LICENSE_KEY
          valueFrom:
            configMapKeyRef:
              name: new-relic-config
              key: NEW_RELIC_LICENSE_KEY
        - name: NEW_RELIC_LOG
          valueFrom:
            configMapKeyRef:
              name: new-relic-config
              key: NEW_RELIC_LOG
        - name: IFS_SUBSIDY_CONTROL_NORTHERN_IRELAND_ENABLED
          valueFrom:
            configMapKeyRef:
              name: feature-toggle-config
              key: IFS_SUBSIDY_CONTROL_NORTHERN_IRELAND_ENABLED
        - name: SPRING_PROFILES_ACTIVE
          valueFrom:
            configMapKeyRef:
              name: spring-config
              key: SPRING_PROFILES_ACTIVE
        - name: JAVA_OPTS
          value: -Xms750m -Xmx750m -javaagent:/newrelic.jar
        - name: NEW_RELIC_APP_NAME
          value: "ifs-application-service (${openshiftEnv})"
      ports:
        - containerPort: 8080
      resources:
        limits:
          cpu: 1000m
        requests:
          cpu: 100m
          memory: 1G