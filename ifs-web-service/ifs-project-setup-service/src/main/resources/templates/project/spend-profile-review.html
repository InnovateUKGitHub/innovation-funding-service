<!DOCTYPE html>
<html lang="en" class="govuk-template" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:insert="fragments/layout :: head" th:with="pageTitle=|Spend profile - ${model.projectName}|" />
</head>
<body class="govuk-template__body app-overview" th:classappend="${(param.view != null and param.view[0] == 'full' ? 'wide-page' : '')}">

<th:block th:insert="fragments/layout :: body-start" />
<th:block th:insert="fragments/layout :: global-header" />

<div class="govuk-width-container">
    <th:block th:insert="fragments/layout :: phase-banner" />
    <th:block th:insert="fragments/layout :: header-sub" th:with="linkTitle='Set up your project',linkUrl=@{/project/{id}(id=${model.projectId})}" />

    <main class="govuk-main-wrapper" id="main-content" role="main">
        <div th:if="${#fields.hasErrors('${form.*}')}" class="govuk-error-summary"
             aria-labelledby="error-summary-title"
             role="alert"
             tabindex="-1"
             data-module="govuk-error-summary">
            <h2 class="govuk-error-summary__title" id="error-summary-title">There is a problem</h2>
            <th:block th:insert="fragments/elements :: error-summary-list(form)" />
        </div>
        <th:block th:insert="fragments/layout :: page-title" th:with="pageTitle='Spend profile',subTitle=${model.applicationId+ ': ' + model.projectName},size='govuk-heading-xl'" />

        <th:block th:unless="${model.showMoSpendProfileJourney()}">
            <th:block th:if="${model.submitted and !model.approved}">
                <div class="success-alert govuk-!-margin-bottom-6">
                    <p class="govuk-body"><strong>All project spend profiles have been sent to Innovate UK.</strong></p>
                </div>
            </th:block>

            <th:block th:if="${model.submitted and model.approved}">
                <div class="success-alert govuk-!-margin-bottom-6">
                    <th:block th:if="${model.isMoSpendProfileJourneyUpdateEnabled()}">
                        <th:block th:if="${model.isSpendProfileReviewedByIfsAdmin()}">
                            <p class="govuk-body"><strong>Innovate UK approved this spend profile on <th:block th:text="${model.spendProfileReviewedOn() != null ? #temporals.format(model.spendProfileReviewedOn(), 'd MMM yyyy') : ''}"></th:block>.</strong></p>
                        </th:block>
                        <th:block th:if="${model.isSpendProfileReviewedByMO()}">
                            <th:block th:if="${model.loggedInUserIsMoOnProject()}">
                                <p class="govuk-body"><strong>You approved this spend profile on <th:block th:text="${model.spendProfileReviewedOn() != null ? #temporals.format(model.spendProfileReviewedOn(), 'd MMM yyyy') : ''}"></th:block>.</strong></p>
                            </th:block>
                            <th:block th:unless="${model.loggedInUserIsMoOnProject()}">
                                <p class="govuk-body"><strong><th:block th:text="${model.userWhoApprovedSpendProfile()}"></th:block> approved this spend profile on <th:block th:text="${model.spendProfileReviewedOn() != null ? #temporals.format(model.spendProfileReviewedOn(), 'd MMM yyyy') : ''}"></th:block>.</strong></p>
                            </th:block>
                        </th:block>

                    </th:block>
                    <th:block th:unless="${model.isMoSpendProfileJourneyUpdateEnabled()}">
                        <p class="govuk-body"><strong>All project spend profiles have been accepted by Innovate UK.</strong></p>
                    </th:block>
                </div>
            </th:block>

            <p class="govuk-body" th:unless="${model.isMarkAsComplete()}">
                This overview shows the spend profile status of each organisation in your project.</p>
            <div class="message-alert govuk-!-margin-bottom-6" th:if="${model.isMarkAsComplete() and !model.submitted}">
                <p class="govuk-body" >
                    All spend profiles have been completed. You must now review the spend profile for each organisation.</p>
            </div>

            <th:block th:if="${model.submitted}">
                <p class="govuk-body" th:if="${!model.approved}" >All spend profiles have been sent to Innovate UK and the Monitoring Officer assigned to this application.
                    You may view these profiles.</p>
                <p class="govuk-body" th:if="${model.approved}">All spend profiles have been accepted by Innovate UK and the Monitoring Officer assigned to this application.
                    You may view these profiles.</p>
            </th:block>

            <ul class="task-list">
                <li th:unless="${#lists.isEmpty(model.editablePartners)}"
                    th:each="partner : ${model.editablePartners}">
                    <div class="task">
                        <h3 class="govuk-heading-s">
                            <a th:if="${partner.value.showEditLinkToUser}"
                               th:href="@{/project/{id}/partner-organisation/{organisationId}/spend-profile/review(id=${model.projectId}, organisationId=${partner.key})}"
                               th:text="${partner.value.organisationName}"
                               class="govuk-link"/>
                            <th:block th:unless="${partner.value.showEditLinkToUser}"
                                      th:text="${partner.value.organisationName}" />
                            <th:block th:if="${partner.value.organisationName.equals(model.leadOrganisation.name)}"> (Lead)</th:block>
                        </h3>
                    </div>
                    <div th:if="${partner.value.markedComplete}" class="task-status-complete">
                        <span>Complete</span>
                    </div>
                    <span th:unless="${partner.value.markedComplete}" class="notification">
                    In progress
                </span>
                </li>
            </ul>
        </th:block>

        <th:block th:if="${model.showMoSpendProfileJourney()}">
            <div class="govuk-!-margin-top-0">
                <th:block th:if="${model.approved}">
                    <div class="success-alert govuk-!-margin-bottom-9">
                        <th:block th:if="${model.isSpendProfileReviewedByIfsAdmin()}">
                            <p class="govuk-body"><strong>Innovate UK approved this spend profile on <th:block th:text="${model.spendProfileReviewedOn() != null ? #temporals.format(model.spendProfileReviewedOn(), 'd MMM yyyy') : ''}"></th:block>.</strong></p>
                        </th:block>
                        <th:block th:if="${model.isSpendProfileReviewedByMO()}">
                            <th:block th:if="${model.loggedInUserIsMoOnProject()}">
                                <p class="govuk-body"><strong>You approved this spend profile on <th:block th:text="${model.spendProfileReviewedOn() != null ? #temporals.format(model.spendProfileReviewedOn(), 'd MMM yyyy') : ''}"></th:block>.</strong></p>
                            </th:block>
                            <th:block th:unless="${model.loggedInUserIsMoOnProject()}">
                                <p class="govuk-body"><strong><th:block th:text="${model.userWhoApprovedSpendProfile()}"></th:block> approved this spend profile on <th:block th:text="${model.spendProfileReviewedOn() != null ? #temporals.format(model.spendProfileReviewedOn(), 'd MMM yyyy') : ''}"></th:block>.</strong></p>
                            </th:block>
                        </th:block>
                    </div>
                </th:block>

                <th:block th:if="${model.rejected}">
                    <div class="message-alert govuk-!-margin-bottom-9">
                        <th:block th:if="${model.isSpendProfileReviewedByIfsAdmin()}">
                            <p class="govuk-body">Innovate UK rejected this spend profile on <th:block th:text="${model.spendProfileReviewedOn() != null ? #temporals.format(model.spendProfileReviewedOn(), 'd MMM yyyy') : ''}"></th:block>.</p>
                        </th:block>
                        <th:block th:if="${model.isSpendProfileReviewedByMO()}">
                            <th:block th:if="${model.loggedInUserIsMoOnProject()}">
                                <p class="govuk-body">You have rejected this spend profile. Please contact the project manager to explain your decision.</p>
                            </th:block>
                            <th:block th:unless="${model.loggedInUserIsMoOnProject()}">
                                <p class="govuk-body"><th:block th:text="${model.userWhoApprovedSpendProfile()}"></th:block> has rejected this spend profile. Please contact the project manager to explain the decision.</p>
                            </th:block>
                        </th:block>
                    </div>
                </th:block>

                <p class="govuk-body">Please review the spend profile submitted by the project manager. You must accept or reject it based on Innovate UK's requirements.</p>

                <table id="table-mo-spend-profile" class="govuk-table">
                    <thead class="govuk-table__head">
                    <tr class="govuk-table__row">
                        <th class="govuk-table__header" scope="col">View details</th>
                        <th class="govuk-table__header" scope="col">Download file</th>
                        <th class="govuk-table__header alignright" scope="col">Status</th>
                    </tr>
                    </thead>
                    <tbody class="govuk-table__body">
                    <tr class="govuk-table__row" th:each="partner : ${model.editablePartners}">
                        <td class="govuk-table__cell govuk-!-font-weight-bold">
                            <a th:if="${partner.value.showEditLinkToUser}"
                               th:href="@{/project/{id}/partner-organisation/{organisationId}/spend-profile/review(id=${model.projectId}, organisationId=${partner.key})}"
                               th:text="${partner.value.organisationName}"
                               class="govuk-link"/>
                            <th:block th:unless="${partner.value.showEditLinkToUser}"
                                      th:text="${partner.value.organisationName}" />
                            <th:block th:if="${partner.value.organisationName.equals(model.leadOrganisation.name)}"> (Lead)</th:block>
                        </td>
                        <td class="govuk-table__cell">
                            <a th:href="'/project-setup-management/project/' + ${model.projectId} + '/partner-organisation/' + ${partner.value.organisationId} + '/spend-profile-export/csv'"
                               th:text="${partner.value.organisationName} + '-spend-profile.csv'"
                               class="govuk-link">spend-profile.csv</a>
                        </td>
                        <td class="govuk-table__cell alignright">
                            <div class="status">
                                <div th:if="${partner.value.markedComplete}" class="task-status-complete">
                                    <span>Complete</span>
                                </div>
                                <div th:unless="${partner.value.markedComplete}" class="task-status-incomplete">
                                    <span>Incomplete</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <th:block th:if="${model.userCanReviewSpendProfile()}">
                <form th:object="${form}"
                      th:action="@{${#ifsUtil.formPostUri(#httpServletRequest)}}"
                      method="post"
                      novalidate="novalidate">
                    <h2 class="govuk-heading-m govuk-!-margin-top-9">Review spend profile</h2>
                    <div class="govuk-form-group">
                        <fieldset class="govuk-fieldset">
                            <legend id="radio-review" class="govuk-fieldset__legend govuk-fieldset__legend--s">
                            </legend>
                            <div class="govuk-radios">
                                <div class="govuk-radios__item">
                                    <input class="govuk-radios__input"
                                           id="radio-review-approve"
                                           name="approved"
                                           type="radio"
                                           value="true"
                                           required="required"
                                           data-switches-button-status="#submit-button"
                                           data-switches-modal-target="#submit-button">
                                    <label class="govuk-label govuk-radios__label" for="radio-review-approve">
                                        Approve
                                    </label>
                                </div>
                                <div class="govuk-radios__item">
                                    <input class="govuk-radios__input"
                                           id="radio-review-reject"
                                           name="approved"
                                           type="radio"
                                           value="false"
                                           required="required"
                                           data-switches-button-status="#submit-button"
                                           data-switches-modal-target="#submit-button">
                                    <label class="govuk-label govuk-radios__label" for="radio-review-reject">
                                        Reject
                                    </label>
                                </div>
                            </div>
                        </fieldset>
                    </div>
                    <button class="govuk-button" type="submit" id="submit-button" data-js-modal=""
                            data-enable-button-when="one-checked">Submit
                    </button>
                </form>
            </th:block>
        </th:block>

        <th:block th:if="${model.markAsComplete and !model.submitted and !model.monitoringOfficer}">
            <a th:href="@{/project/{id}/spend-profile/total(id=${model.projectId})}" class="govuk-button">Review and submit project spend profile</a>
        </th:block>

        <th:block th:insert="fragments/layout :: main-content-end" />
    </main>
</div>

<th:block th:insert="fragments/layout :: footer" />
<th:block th:insert="fragments/layout :: body-end" />

</body>
</html>
