<!DOCTYPE html>
<html class="no-js" lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <div th:include="fragments/layout :: head" th:with="pageTitle='Application Details'" th:remove="tag"></div>
</head>
<body th:with="context='applicant'" class="app-invite">

<div th:include="fragments/layout :: body-start" th:remove="tag"></div>
<div th:include="fragments/layout :: global-header" th:remove="tag"></div>

<main id="content">
    <div th:include="fragments/layout :: main-content-start" th:remove="tag"></div>

    <!--/* manage application text */-->
    <div th:if="${param.newApplication == null}" th:remove="tag">
      <div th:include="fragments/layout :: header-sub" th:with="linkTitle='Back',linkClass='link-back',linkUrl=@{/application/{id}/contributors(id=${currentApplication.getId()})},currentApplication=${currentApplication}" th:remove="tag" />
      <div class="page-title">
          <div th:include="fragments/elements :: application-title (application=${currentApplication})" th:remove="tag" />
          <h1 class="heading-xlarge">Manage Contributors</h1>
      </div>
      <p>From this page you are able to invite contributors to your application. To save your changes, please click on 'save changes' at the bottom of the page.</p>
    </div>
    <!--/* new application text */-->
    <div th:if="${param.newApplication != null}" th:remove="tag">
      <h1 class="heading-large">Inviting Contributors and Partners</h1>
      <h2 class="heading-medium no-margin" th:text="${currentCompetition.getName() + '- New application'}" />
      <p>You can invite new contributors at any time, but your application must have at least one collaborative partner for this competition.</p>
    </div>

    <section class="message-alert" th:if="${leadApplicant.id == authenticatedUser.id}">
        <h2 class="heading-small">You are the lead applicant</h2>
        <p>
          As the lead applicant you can manage your contributors or partners in this section.
          You may invite other contributors, assign questions and coordinate partners.
          The status of other contributors will be pending until they have accepted the invitation.
        </p>
    </section>

    <form action="#" th:action="@{${#ifsUtil.uriWithQueryString(#httpServletRequest)}}" th:object="${contributorsForm}" method="POST" class="contributorsForm">
        <div class="error-summary" th:if="${#fields.hasErrors('*')}">
            <h2 class="heading-medium error-summary-heading">
                We are unable to send the invites out:
            </h2>
            <ul class="error-summary-list">
                <li th:each="err : ${#fields.errors('*')}" th:text="${err}"></li>
            </ul>
        </div>

        <button class="hidden-save" type="submit" aria-hidden="true" value="save form" tabindex="-1"/>
        <ul class="boxed-list">
            <li th:each="organisationInviteForm, organisationStats: ${contributorsForm.organisations}" th:attr="data-invite-org=${organisationStats.index}">
                <!--/* lead org */-->
                <div th:if="${organisationStats.index == 0}" th:remove="tag">
                  <h3 class="heading-medium">
                    Lead Organisation "<span th:remove="tag" th:text="${organisationInviteForm.organisationName}"/>"
                  </h3>
                    <p th:if="${leadApplicant?.id eq authenticatedUser?.id}">You are the lead partner for both the project and application.
                      Add members of your own organisation to contribute to this application.
                    </p>
                    <p th:unless="${leadApplicant?.id eq authenticatedUser?.id}">Only the lead applicant can add members of their own organisation.
                    </p>
                </div>
                <!--/* partner org */-->
                <div th:unless="${organisationStats.index == 0}" th:remove="tag">
                  <h3 class="heading-medium">Partner Organisation</h3>

                    <div th:class="${#fields.hasErrors('organisations[__${organisationStats.index}__].organisationName') ? 'form-group error' : 'form-group'}">
                        <label class="form-label" th:for="'organisations'+${organisationStats.index}+'.organisationName'">
                              <span>Organisation Name</span>
                              <span th:if="${#fields.hasErrors('organisations[__${organisationStats.index}__].organisationName')}" th:remove="tag">
                                    <span class="error-message"  th:each="err : ${#fields.errors('organisations[__${organisationStats.index}__].organisationName')}" th:text="${err}" />
                              </span>
                        </label>
                        <input type="text"
                               class="form-control js-partner-name"
                               placeholder="Name of the partner company"
                               th:errorclass="field-error"
                               th:field="*{organisations[__${organisationStats.index}__].organisationName}"

                               th:readonly="${organisationInviteForm.organisationInviteId != null} and ${organisationInvites?.get(organisationInviteForm.organisationInviteId)?.inviteResources?.size()}"/>
                    </div>
                    <div th:if="${organisationInviteForm.organisationNameConfirmed != null}" th:class="${#fields.hasErrors('organisations[__${organisationStats.index}__].organisationNameConfirmed') ? 'form-group error' : 'form-group'}">
                        <label class="form-label" th:for="organisations[__${organisationStats.index}__].organisationNameConfirmed">
                              <span>Confirmed Organisation Name </span>
                              <span th:if="${#fields.hasErrors('organisations[__${organisationStats.index}__].organisationNameConfirmed')}" th:remove="tag">
                                    <span class="error-message"  th:each="err : ${#fields.errors('organisations[__${organisationStats.index}__].organisationNameConfirmed')}" th:text="${err}" />
                              </span>
                        </label>
                        <input type="text"
                               class="form-control"
                               th:field="*{organisations[__${organisationStats.index}__].organisationNameConfirmed}"
                               readonly="readonly" />
                    </div>
                </div>
                <!--/* all org */-->
                <!--<div th:text="${organisationStats.index}"></div>-->
                <input type="hidden" class="form-control width-full"  th:field="*{organisations[__${organisationStats.index}__].organisationId}"/>
                <input type="hidden" class="form-control width-full"  th:field="*{organisations[__${organisationStats.index}__].organisationInviteId}"/>

                <table>
                    <thead>
                    <tr>
                        <th>Applicant name</th>
                        <th>Email</th>
                        <th>&nbsp;</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${organisationInviteForm.organisationId == leadOrganisation.id}">
                        <td class="form-group">
                            <label for="lead-name"><span class="visuallyhidden">Lead applicant name</span></label>
                            <input type="text" id="lead-name" class="form-control width-full" th:value="${leadApplicant.name}" readonly="readonly"/>
                        </td>
                        <td class="form-group">
                            <label class="visuallyhidden" for="lead-email"><span class="visuallyhidden">Lead applicant name</span></label>
                            <input type="text" class="form-control width-full" id="lead-email" th:value="${leadApplicant.email}" readonly="readonly"/>
                        </td>
                        <td class="alignright remove">
                            Lead applicant
                        </td>
                    </tr>
                    <div th:if="${organisationInviteForm.organisationInviteId != null} and ${organisationInvites?.get(organisationInviteForm.organisationInviteId)?.inviteResources?.size()}" th:remove="tag">
                        <tr th:each="invite, iteration: ${organisationInvites.get(organisationInviteForm.organisationInviteId).inviteResources}">
                            <td class="form-group" >
                                <label th:for="'invited-'+${iteration.count}+'-name'"><span class="visuallyhidden">Name</span></label>
                                <input th:id="'invited-'+${iteration.count}+'-name'" class="form-control width-full" type="text" readonly="readonly" th:value="${invite.name}" />
                            </td>
                            <td class="form-group">
                                <label th:for="'invited-'+${iteration.count}+'-email'"><span class="visuallyhidden">Name</span></label>
                                <input th:id="'invited-'+${iteration.count}+'-email'" class="form-control width-full" type="text" readonly="readonly" th:value="${invite.email}" />
                            </td>
                            <td class="alignright">
                              <div th:remove="tag" th:if="${invite.status.name() == 'CREATED' || invite.status.name() == 'SEND'}">(pending)</div>
                            </td>
                        </tr>
                    </div>
                    <tr th:each="user, userStats: ${organisationInviteForm.invites}" data-invite-row="">
                        <td th:class="${#fields.hasErrors('organisations[__${organisationStats.index}__].invites[__${userStats.index}__].personName') ? 'form-group error' : 'form-group'}"
                            th:unless="${user.getInviteStatus() != null}">
                            <label th:for="'organisations'+${organisationStats.index}+'.invites'+${userStats.index}+'.personName'">
                                  <span class="visuallyhidden">Name</span>
                                  <span th:if="${#fields.hasErrors('organisations[__${organisationStats.index}__].invites[__${userStats.index}__].personName')}" th:remove="tag">
                                        <span class="error-message"  th:each="err : ${#fields.errors('organisations[__${organisationStats.index}__].invites[__${userStats.index}__].personName')}" th:text="${err}" />
                                  </span>
                            </label>
                            <input type="text" class="form-control width-full"
                                   placeholder="name"
                                   th:errorclass="field-error"
                                   th:field="*{organisations[__${organisationStats.index}__].invites[__${userStats.index}__].personName}"
                                    />
                        </td>
                        <td th:unless="${user.getInviteStatus() != null}"  th:class="${#fields.hasErrors('organisations[__${organisationStats.index}__].invites[__${userStats.index}__].email') ? 'form-group error' : 'form-group'}">
                            <label th:for="'organisations'+${organisationStats.index}+'.invites'+${userStats.index}+'.email'">
                                  <span class="visuallyhidden">email</span>
                                  <span th:if="${#fields.hasErrors('organisations[__${organisationStats.index}__].invites[__${userStats.index}__].email')}" th:remove="tag">
                                        <span class="error-message"  th:each="err : ${#fields.errors('organisations[__${organisationStats.index}__].invites[__${userStats.index}__].email')}" th:text="${err}" />
                                  </span>
                            </label>
                            <input type="email" class="form-control width-full"
                                   placeholder="name@company.co.uk"
                                   th:errorclass="field-error"
                                   th:field="*{organisations[__${organisationStats.index}__].invites[__${userStats.index}__].email}"
                                    />
                        </td>
                        <td class="form-group " th:if="${user.getInviteStatus() != null}">
                              <span th:text="${user.personName}"></span>
                        </td>
                        <td class="form-group" th:if="${user.getInviteStatus() != null}" >
                            <span th:text="${user.email}"></span>
                        </td>
                        <td class="alignright">
                            <span th:if="${user.userId == authenticatedUser.id}">That's you!</span>
                            <button class="remove-another-row buttonlink" type="submit" name="remove_person"
                                    th:value="${organisationStats.index + '_' + userStats.index}">Remove
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>

                <div class="alignright">
                    <button th:if="${leadApplicant.id == authenticatedUser.id || organisationInviteForm.organisationId == authenticatedUserOrganisation}" class="add-another-row buttonlink" type="submit" name="add_person" th:value="${organisationStats.index}">Add another person</button>
                </div>
            </li>
            <li th:if="${leadApplicant.id == authenticatedUser.id}">
                <button class="buttonlink" type="submit" name="add_partner" value="">Add additional partner organisation</button>
                <p>Add any partner organisations collaborating with you on this project. Partners are responsible for creating their own account and submitting their finances.</p>
            </li>
        </ul>
        <p class="extra-margin">
          We will send emails to each of these partners inviting them to join the application.
          Once the partner has accepted the invitation you will be able to assign section of the application to them.
        </p>
        <button th:text="${param.newApplication != null ? 'Begin application' : 'Save Changes'}" type="submit" name="save_contributors" class="button" />
    </form>


    <div th:include="fragments/layout :: main-content-end" th:remove="tag"></div>
</main>

<div th:include="fragments/layout :: footer" th:remove="tag"></div>
<div th:include="fragments/layout :: body-end" th:remove="tag"></div>
</body>
</html>
