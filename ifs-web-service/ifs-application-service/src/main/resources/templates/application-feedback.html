<!DOCTYPE html>
<html class="no-js" lang="en" xmlns:th="http://www.w3.org/1999/xhtml" xmlns:ifs="http://www.w3.org/1999/xhtml">
    <head>
        <th:block th:insert="fragments/layout :: head" th:with="pageTitle='Feedback overview'" />
    </head>

    <body class="app-summary" th:classappend="${model.application.isOpen() ? 'is-open' : 'is-closed' }">
        <th:block th:insert="fragments/layout :: body-start" />
        <th:block th:insert="fragments/layout :: global-header" />

        <main tabindex="-1" id="content">
            <th:block th:insert="fragments/layout :: header-sub" th:with="linkTitle='Dashboard',linkClass='link-back',linkUrl=@{/applicant/dashboard}"/>
            <th:block th:insert="fragments/elements :: competition-closing-warning (competition=${model.competition})" />
            <th:block th:with="applicationName=${#strings.isEmpty(model.application.name)} ? #{ifs.application.no_title} : ${model.application.name}">
                <th:block th:insert="fragments/layout :: page-title" th:with="pageTitle='Feedback overview',subTitle=${model.application.name},size='heading-xlarge'" />
            </th:block>

            <th:block th:insert="fragments/elements :: competition-status-message (app=${model.application}, competition=${model.competition})" />

            <h2 class="heading-medium no-margin-bottom">Application details</h2>
            <p class="form-hint">Assessors do not provide scores on these sections of the application.</p>

            <div class="boxed">
                <div class="grid-row">
                    <div class="column-half">
                        <h3 class="heading-small">Project title</h3>
                        <p th:text="${model.application.name}">Machine learning in robots</p>

                        <h3 class="heading-small">Application number</h3>
                        <p th:text="${model.application.id}">Machine learning in robots</p>

                        <h3 class="heading-small">Lead organisation</h3>
                        <p th:text="${model.leadOrganisation.name}">Aptrans Ltd</p>

                        <h3 class="heading-small">Partners</h3>
                        <ul class="list">
                            <li th:each="organisation : ${model.applicationOrganisations}" th:unless="${organisation.equals(model.leadOrganisation)}" th:text="${organisation.name}">Biotech Corp</li>
                        </ul>
                    </div>

                    <div class="column-half">
                        <h3 class="heading-small">Project timescales</h3>
                        <p>Project start date: <br />
                            <th:block
                                th:if="${model.application.startDate}"
                                th:text="${#temporals.format(model.application.startDate, 'd MMMM yyyy')}" />
                        </p>
                        <p>Duration: <br /><th:block th:text="${model.application.durationInMonths}" /> months</p>

                        <h3 class="heading-small extra-margin">Total project cost</h3>
                        <p>&pound;<th:block th:text="${model.totalFundingSought} ? ${#numbers.formatInteger(model.totalFundingSought, 0, 'DEFAULT')} : '0'">203,567</th:block></p>
                    </div>
                </div>
            </div>

            <div th:unless="${model.interviewFeedbackViewModel == null || model.interviewFeedbackViewModel.feedbackReleased}" class="message-alert">
                <p th:text="${model.interviewFeedbackViewModel.bannerText}">Some info</p>
            </div>

            <th:block th:if="${model.interviewFeedbackViewModel != null && model.interviewFeedbackViewModel.responseSectionEnabled}">
                <th:block th:if="${model.interviewFeedbackViewModel.leadApplicant}">
                    <form th:action="@{/application/{applicationId}/feedback(applicationId=${model.application.id})}"
                          method="post" enctype="multipart/form-data" th:object="${interviewResponseForm}" novalidate="novalidate">
                        <h2 class="heading-medium">Your response</h2>
                        <div class="upload-section">
                            <details th:unless="${model.interviewFeedbackViewModel.feedbackReleased}" role="group">
                                <summary role="button" aria-controls="details-content-0" aria-expanded="false">
                                    <span class="summary">What should I include in the response?</span>
                                </summary>
                                <div class="panel" id="details-content-0" aria-hidden="true">
                                    <p>You may submit a written response to this feedback. You can upload up to 3 A4 pages in a single PDF
                                        document, including charts and diagrams. The maximum file upload size is 2MB.</p>
                                </div>
                            </details>
                            <div th:unless="${model.interviewFeedbackViewModel.hasResponse()}"th:classappend="${#fields.hasErrors('response')} ? 'form-group-error'">
                                <th:block th:if="${#fields.hasErrors('response')}">
                                    <span class="error-message" th:each="err : ${#fields.errors('response')}" th:text="${err}" />
                                </th:block>
                                <p class="uploaded-file">No file currently uploaded</p>
                                <input type="file" id="response" name="response" class="inputfile">
                                <label for="response" class="button-secondary extra-margin">+ Upload</label>
                                <button name="uploadResponse" class="button-secondary" data-for-file-upload="response"></button>
                            </div>
                            <div th:if="${model.interviewFeedbackViewModel.hasResponse()}">
                                <p class="uploaded-file"><a th:href="@{/application/{applicationId}/feedback/download-response(applicationId=${model.application.id})}"
                                                            th:text="${model.interviewFeedbackViewModel.responseFilename}"
                                                            target="_blank">File</a> (opens in a new window)</p>
                                <button th:unless="${model.interviewFeedbackViewModel.feedbackReleased}" name="removeResponse" class="button-secondary">Remove</button>
                            </div>
                        </div>
                    </form>
                </th:block>
                <th:block th:unless="${model.interviewFeedbackViewModel.leadApplicant}">
                    <h2 class="heading-medium">Response from lead applicant</h2>
                    <th:block th:unless="${model.interviewFeedbackViewModel.hasResponse()}">
                        <p>The lead applicant has not yet uploaded a response.</p>
                    </th:block>
                    <th:block th:if="${model.interviewFeedbackViewModel.hasResponse()}">
                        <div class="form-group download">
                            <h3 class="heading-small no-margin">Lead applicant response</h3>
                            <p class="uploaded-file"><a th:href="@{/application/{applicationId}/feedback/download-response(applicationId=${interviewFeedbackViewModel.application.id})}"
                                                        th:text="${model.interviewFeedbackViewModel.responseFilename + ' (opens in a new window)'}"
                                                        target="_blank">File</a></p>
                        </div>
                    </th:block>
                </th:block>
            </th:block>

            <section th:each="section : ${model.sections.values()}" th:unless="${section.name.equals('Finances')}">
                <th:block th:if="${section.name.equals('Project details')}">
                    <ul class="list-overview extra-margin">
                        <th:block th:each="question : ${model.sectionQuestions.get(section.id)}" th:unless="${question.questionSetupType == T(org.innovateuk.ifs.competition.resource.CompetitionSetupQuestionType).APPLICATION_DETAILS}">
                            <li class="section-status">
                                <div class="grid-row">
                                    <div class="column-two-thirds">
                                        <h3 class="heading-small">
                                            <a th:href="@{/application/{apId}/question/{qId}/feedback(apId=${model.application.id},qId=${question.id})}"
                                            th:text="${question.shortName}" >Project summary</a>
                                        </h3>
                                    </div>
                                    <div class="column-third">
                                        <th:block th:if="${question.questionSetupType == T(org.innovateuk.ifs.competition.resource.CompetitionSetupQuestionType).SCOPE}">
                                            <p th:unless="${model.scores.scopeAssessed}" class="form-hint no-margin">No feedback provided</p>
                                            <p th:if="${model.scores.scopeAssessed}">
                                                In scope? <span th:text="${model.scores.inScope}">4</span>/<span th:text="${model.scores.totalScope}">5</span>
                                            </p>
                                        </th:block>
                                        <th:block th:unless="${question.questionSetupType == T(org.innovateuk.ifs.competition.resource.CompetitionSetupQuestionType).SCOPE}">
                                            <p class="form-hint no-margin">No feedback provided</p>
                                        </th:block>
                                    </div>
                                </div>
                            </li>
                        </th:block>
                    </ul>
                </th:block>
                <th:block th:if="${!section.name.equals('Project details')}">
                    <h2 class="heading-medium no-margin-bottom">Application questions</h2>
                    <p class="form-hint">Each question has been assessed by several independent assessors. They have given a score and feedback for each.</p>

                    <ul class="list-overview">
                        <li class="section-status" th:each="question : ${model.sectionQuestions.get(section.id)}">
                        <div class="grid-row">
                            <div class="column-two-thirds">
                                <h3 class="heading-small">
                                    <a th:href="@{/application/{apId}/question/{qId}/feedback(apId=${model.application.id},qId=${question.id})}"
                                        th:text="${question.questionNumber!=null ? question.questionNumber + '. ' : '' } + ${question.shortName}">1. Business opportunity</a>
                                </h3>
                            </div>
                            <div>
                                <div class="column-third" th:text="|Average score ${model.scores.scores.get(question.id)} / ${question.assessorMaximumScore}|">Average score 7 / 10</div>
                            </div>
                        </div>
                        </li>
                    </ul>
                    <div class="grid-row extra-margin">
                        <div class="column-two-thirds">
                            &nbsp;
                        </div>
                        <div class="column-third">
                            <p>Average overall: <strong class="heading-" th:text="|${model.scores.averagePercentage}%|">70%</strong></p>
                        </div>
                    </div>
                </th:block>
            </section>

            <th:block th:if="${model.interviewFeedbackViewModel != null && model.interviewFeedbackViewModel.hasFeedback()}">
                <h2 class="heading-medium">Additional feedback</h2>
                <div class="form-group download">
                    <h3 class="heading-small no-margin">Panel assessment feedback</h3>
                    <a target="_blank" href=""
                       th:href="@{/application/{applicationId}/feedback/download-feedback(applicationId=${model.application.id})}"
                       th:text="${model.interviewFeedbackViewModel.feedbackFilename}">panel-assessment-feedback.pdf, 6 KB </a> (opens in a new window)
                </div>
            </th:block>

            <section th:if="${model.hasFinanceSection}">
                <h2 class="heading-medium">Finance</h2>
                <div class="collapsible">
                    <h3>Finances summary</h3>
                    <div class="question">
                        <div ifs:global="${model.applicationFinanceSummaryViewModel}" th:replace="finance/finance-summary :: application_finances_summary (isApplicant = true)"></div>
                        <h2 class="heading-medium">Funding breakdown</h2>
                        <th:block ifs:global="${model.applicationFundingBreakdownViewModel}" th:insert="finance/finance-summary :: financial_summary_table" />
                    </div>
                </div>
            </section>

            <div th:if="!${#lists.isEmpty(model.feedback)}">
                <h2 class="heading-medium">Assessor feedback</h2>
                <ul class="boxed-list">
                    <li th:each="item, iterStat : ${model.feedback}">
                        <h3 class="heading-small" th:text="|Assessor ${iterStat.count}|">Assessor 1</h3>
                        <div th:text="${item}" data-text-to-html="" class="wysiwyg-styles">Feedback text</div>
                    </li>
                </ul>
            </div>

            <th:block th:insert="fragments/layout :: main-content-end" />
        </main>

        <th:block th:insert="fragments/layout :: footer" />
        <th:block th:insert="fragments/layout :: body-end" />
        <th:block th:insert="fragments/service-layout :: body-end" />
    </body>
</html>
