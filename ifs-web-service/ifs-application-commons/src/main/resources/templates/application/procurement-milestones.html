<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<!--/*@thymesVar id="form" type="org.innovateuk.ifs.application.forms.sections.procurement.milestones.form.ProcurementMilestonesForm"*/-->
<!--/*@thymesVar id="model" type="org.innovateuk.ifs.application.forms.sections.procurement.milestones.viewmodel.AbstractProcurementMilestoneViewModel"*/-->

<th:block th:fragment="milestones-form(form, model)">

    <div class="procurement-milestones govuk-!-margin-bottom-2">
        <div class="govuk-accordion" data-module="govuk-accordion" id="accordion-finances">
            <h4 class="width-20-percent govuk-heading-s">Month completed</h4>
            <h4 class="width-48-percent govuk-heading-s govuk-!-margin-left-1">Milestone</h4>
            <h4 class="width-10-percent govuk-heading-s">% of project costs</h4>
            <h4 class="width-10-percent govuk-heading-s">Payment request</h4>
            <th:block th:each="entry : ${form.milestones}">
                <th:block th:insert="this :: milestones-row(${entry.key}, ${entry.value}, ${model})"></th:block>
            </th:block>
        </div>
        <p class="alignright" th:unless="${model.readOnly}">
            <button type="submit"
                    data-repeatable-rowcontainer=".procurement-milestones .govuk-accordion"
                    name="add_row"
                    class="button-clear">Add another project milestone
            </button>
        </p>

        <h3 id="totalErrorHolder" class="govuk-heading-m width-80-percent"
            th:classappend="${#fields.hasErrors('*{totalErrorHolder}')} ? 'error-heading-icon' : ''">Total payment requested</h3>
        <h3 class="govuk-heading-m width-10-percent"
            th:text="|${#numbers.formatDecimal(form.getTotalPercentages(model.fundingAmount), 1, 'DEFAULT', 2, 'DEFAULT')}%|"
            data-calculation-format="decimal-percentage"
            data-calculation-operations="/,*"
            th:attr="data-calculation-fields=|100, ${model.fundingAmount}, #payment-total|"></h3>
        <h3 id="payment-total" class="govuk-heading-m width-10-percent" th:text="'£' + ${#numbers.formatInteger(form.totalPayments, 0,'DEFAULT')}"
            data-calculation-format="currency"
            data-calculation-operations="+"
            data-calculation-fields=".payment-amount"></h3>
        <th:block
            th:insert="question-type/form-elements :: form-validation-custom-messages (errorId='totalErrorHolder')"/>
        <input th:each="err : ${#fields.errors('totalErrorHolder')}"
               type="hidden"
               data-calculation-operations="*"
               th:attr="data-calculation-fields=|1, #payment-total|,
                        data-anychange-errormessage=${err}" />
    </div>
</th:block>

<th:block th:fragment="ajax-milestone-row">
    <th:block th:object="${form}">
        <th:block th:insert="this :: milestones-row(${id}, ${row}, ${model})"></th:block>
    </th:block>
</th:block>

<th:block th:fragment="milestones-row(id, milestone, model)">
    <!--/*@thymesVar id="id" type="java.lang.String"*/-->
    <!--/*@thymesVar id="milestone" type="org.innovateuk.ifs.application.forms.sections.procurement.milestones.form.ProcurementMilestoneForm"*/-->
    <div class="govuk-accordion__section"
        th:with="path=|milestones[${id}]|"
        th:attr="data-repeatable-row=${path}">
        <!--/*@thymesVar id="path" type="java.lang.String"*/-->
        <div class="govuk-accordion__section-header">
            <h3 class="govuk-accordion__section-heading">
                <span class="width-20-percent accordion-header-text govuk-!-margin-right-1"
                      th:text="${milestone.month}"
                      th:attr="data-mirror=|[id='__${path}__.month']|"></span>
                <span class="width-48-percent govuk-accordion__section-button" th:id="|accordion-finances-heading-${id}|"
                      th:text="${milestone.description}"
                      th:attr="data-mirror=|[id='__${path}__.description']|"></span>
                <span class="width-10-percent finance-total margin-right-60"
                      th:text="'£' + ${#numbers.formatInteger(milestone.payment, 0,'DEFAULT')}"
                      data-calculation-format="currency"
                      data-calculation-operations="*"
                      th:attr="data-calculation-fields=|1, [id='__${path}__.payment']|"></span>
                <span class="width-10-percent finance-total"
                      th:text="${#numbers.formatInteger(milestone.getPercentageOfFundingAmount(model.fundingAmount), 0,'DEFAULT') + '%'}"
                      th:attr="data-mirror=|[id='__${path}__.percentage']|"></span>
                <!--/*<div th:if="${#ifsUtil.hasErrorsStartingWith('form', 'labour')}"
                     class="section-status section-incomplete icon-
                     only error-marker"></div>*/-->
            </h3>

        </div>
        <div  th:id="|accordion-finances-content-${id}|" class="govuk-accordion__section-content"
              th:attr="aria-labelledby=|accordion-finances-heading-${id}|">
            <input type="hidden" th:field="*{__${path}__.id}" />
            <input type="hidden" th:id="__${path}__.percentage"
                   data-calculation-format="decimal-percentage"
                   data-calculation-operations="/,*"
                   th:attr="data-calculation-fields=|100, ${model.fundingAmount}, [id='__${path}__.payment']|"
                   th:value="|${#numbers.formatDecimal(milestone.getPercentageOfFundingAmount(model.fundingAmount), 1, 'DEFAULT', 2, 'DEFAULT')}%|" />

            <div class="left-col">
                <div th:unless="${model.readOnly}" class="govuk-form-group">
                    <label class="govuk-label govuk-label--s" th:for="__${path}__.month">
                        Month completed
                    </label>
                    <th:block
                        th:insert="question-type/form-elements :: form-validation-custom-messages (errorId=__${path}__.month)"/>
                    <select th:id="__${path}__.month"
                            class="govuk-select"
                            th:errorclass="govuk-select--error"
                            required="required"
                            th:attr="data-required-errormessage=#{validation.procurement.milestones.month}"
                            th:name="__${path}__.month">
                        <option value=""
                                disabled="disabled"
                                th:selected="${milestone.month == null}"></option>
                        <option th:each="duration : ${model.durations}"
                            th:value="${duration}"
                            th:text="${duration}"
                            th:selected="${milestone.month == duration}">1</option>
                    </select>
                </div>
                <input type="hidden" th:if="${model.readOnly}" th:id="__${path}__.month" th:field="*{__${path}__.month}" />
            </div>
            <div class="central-col">
                <div th:unless="${model.readOnly}" class="govuk-form-group">
                    <label th:for="__${path}__.description" class="govuk-label govuk-label--s">
                        Milestone
                    </label>
                    <th:block
                        th:insert="question-type/form-elements :: form-validation-custom-messages (errorId=__${path}__.description)"/>
                    <input th:id="__${path}__.description"
                           th:field="*{__${path}__.description}"
                           th:errorclass="govuk-input--error"
                           type="text"
                           class="govuk-input"
                    />
                </div>
                <input type="hidden" th:if="${model.readOnly}" th:id="__${path}__.description" th:field="*{__${path}__.description}" />

                <div th:unless="${model.readOnly}" class="govuk-form-group">
                    <label class="govuk-label govuk-label--s"
                           th:for="__${path}__.taskOrActivity">Task or activity</label>
                    <th:block
                        th:insert="question-type/form-elements :: form-validation-custom-messages (errorId=__${path}__.taskOrActivity)"/>
                    <textarea
                        th:id="__${path}__.taskOrActivity"
                        rows="8"
                        class="govuk-textarea"
                        th:attr="data-required-errormessage=#{validation.procurement.milestones.taskOrActivity}"
                        required="required"
                        th:field="*{__${path}__.taskOrActivity}">
                    </textarea>
                </div>
                <p th:if="${model.readOnly}" class="govuk-body" th:text="${milestone.taskOrActivity}"></p>

                <div th:unless="${model.readOnly}" class="govuk-form-group">
                    <label class="govuk-label govuk-label--s"
                           th:for="__${path}__.deliverable">Deliverable</label>
                    <th:block
                        th:insert="question-type/form-elements :: form-validation-custom-messages (errorId=__${path}__.deliverable)"/>
                    <textarea
                        th:id="__${path}__.deliverable"
                        rows="8"
                        class="govuk-textarea"
                        th:field="*{__${path}__.deliverable}">
                    </textarea>
                </div>
                <p th:if="${model.readOnly}" class="govuk-body" th:text="${milestone.deliverable}"></p>

                <div th:unless="${model.readOnly}" class="govuk-form-group">
                    <label class="govuk-label govuk-label--s"
                           th:for="__${path}__.successCriteria">Success criteria</label>
                    <th:block
                        th:insert="question-type/form-elements :: form-validation-custom-messages (errorId=__${path}__.successCriteria)"/>
                    <textarea
                        th:id="__${path}__.successCriteria"
                        rows="8"
                        class="govuk-textarea"
                        th:field="*{__${path}__.successCriteria}">
                    </textarea>
                </div>
                <p th:if="${model.readOnly}" class="govuk-body" th:text="${milestone.successCriteria}"></p>

            </div>
            <div class="right-col">
                <div th:unless="${model.readOnly}" class="govuk-form-group">
                    <label th:for="__${path}__.payment" class="govuk-label govuk-label--s">
                        Payment requested (£)
                    </label>
                    <th:block
                        th:insert="question-type/form-elements :: form-validation-custom-messages (errorId=__${path}__.payment)"/>
                    <input th:id="__${path}__.payment"
                           th:field="*{__${path}__.payment}"
                           th:errorclass="govuk-input--error"
                           type="number"
                           class="govuk-input payment-amount"
                           placeholder="0"
                           min="1"
                           max="999999999"
                           step="1"
                           required="required"
                           th:attr="data-required-errormessage=#{validation.procurement.milestones.payment}"
                    />
                </div>
                <input type="hidden" class="payment-amount" th:if="${model.readOnly}" th:id="__${path}__.payment" th:field="*{__${path}__.payment}" />
            </div>
            <p class="alignright" th:unless="${model.readOnly}">
                <button type="submit"
                        th:name="remove_row"
                        th:value="${id}"
                        data-repeatable-rowcontainer=".procurement-milestones .govuk-accordion"
                        class="button-clear js-remove-row">Remove <span class="govuk-visually-hidden">milestone</span>
                </button>
            </p>
        </div>
    </div>
</th:block>
</html>
